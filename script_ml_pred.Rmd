---
title: "Machine learning baseline prediction TBI"
author: "Benjamin Gravesteijn"
date: "20 maart 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(bgravesteijn)
library(foreign)
library(data.table)
library(tableone)
library(mice)
library(miceadds)
library(caret)
library(kernlab)
library(randomForest)
library(gbm)
library(nnet)
library(knitr)
library(rms)
library(patchwork)
library(pROC)
library(glmnet)
nice_res <- function(x){
  paste(sprintf("%.2f",median(x)),
        " (",
        sprintf("%.2f",quantile(x, probs=0.025)),
        " - ",
        sprintf("%.2f",quantile(x, probs=0.975)),
        ")",
        sep="")
        
}
nice_res2 <- function(x,xlo,xhi){
  paste(sprintf(fmt = "%.2f", x)," (", sprintf(fmt = "%.2f", xlo), " - ",sprintf(fmt = "%.2f", xhi), ")", sep="")
  }

varnames <- c("trial", "patid", "age", "hypoxia", "hypotens", "ct_class", 
              "tsah", "edh", "glucose", "sodium", "d_motor", "d_pupil", "d_gos", "hb")

factorvars <- c("trial", "patid", "hypoxia", "hypotens", "ct_class", "tsah", "edh", 
                "d_motor","d_pupil", "d_gos")

##impact prepare
impact <- read.spss("Data/IMPACT11022 Imputed.sav", to.data.frame=TRUE)
impact <- impact[, varnames]

for(i in factorvars){
  impact[,i] <- as.factor(impact[,i])
}

levels(impact$d_motor) <- c(1:6,NA)
levels(impact$d_gos)   <- c(2,2,3:5)

distr.na(impact)

##center preparee
center                                  <- read.csv("Data/core_vars_21-12-2018.csv")
center                                  <- center[center$InjuryHx.GCSScoreBaselineDerived<13&
                                                    !is.na(center$InjuryHx.GCSScoreBaselineDerived),]
center$InjuryHx.GCSScoreBaselineDerived <- NULL

labs   <- read.csv("Data/lab_vars_19-12-2018.csv")
image  <- read.csv("Data/imaging_vars_19-12-2018.csv")

labs$Labs.DLSodiummmolL <- ifelse(is.na(labs$Labs.DLSodiummmolL),
                                  labs$Labs.DLSodiumOther,
                                  labs$Labs.DLSodiummmolL)
labs$Labs.DLGlucosemmolL <- ifelse(labs$Labs.DLGlucoseOtherUnit=="mg/dL",
                                   labs$Labs.DLGlucoseOther*0.0555,
                                   labs$Labs.DLGlucosemmolL)
labs$Labs.DLHemoglobingdL <- ifelse(labs$Labs.DLHemoglobinOtherUnit=="mmol/L",
                                   labs$Labs.DLHemoglobinOther*1.61,
                                   labs$Labs.DLHemoglobingdL)
labs <- data.table(labs)
labs <- labs[,.(first(Labs.DLGlucosemmolL), first(Labs.DLSodiummmolL), first(Labs.DLGlucosemmolL)), by=gupi]
colnames(labs) <- c("gupi", "glucose", "sodium", "hb")

hb_qq99<- quantile(labs$hb, probs=0.99, na.rm = TRUE)
labs$hb[labs$hb>hb_qq99]<-NA

image <- data.table(image)
image <- image[,.(first(Imaging.MarshallCTClassification),
                  first(Imaging.TraumaticSubarachnoidHemorrhage),
                  first(Imaging.EpiduralHematoma)), by=gupi]
colnames(image) <- c("gupi", "ct_class", "tsah", "edh")

center <- merge(center, labs, by="gupi", all.x=TRUE)
center <- merge(center, image, by="gupi", all.x=TRUE)

colnames(center) <- c("patid", "age", "hypoxia", "hypotens", "d_pupil", "d_gos",
                      "d_motor", "glucose", "sodium","hb", "ct_class", "tsah", "edh")

center$trial <- "center"

center <- data.frame(center[,varnames])

for (i in factorvars){
  center[,i] <- as.factor(center[,i])
}

levels(center$hypoxia) <- c(0,1,1,NA)
levels(center$hypotens) <- c(0,1,1,NA)
levels(center$ct_class) <- c(1,2,3,4,5,5)
levels(center$tsah) <- c(NA,0,1,1)
levels(center$edh) <- c(NA,0,1,1)
levels(center$d_gos) <- c(2,3,3,4,4,5,5)
levels(center$d_pupil) <- 1:3

distr.na(center)

both <- rbind(impact, center)

distr.na(both)
yesnovar <- c("hypoxia", "hypotens", "tsah", "edh")
for(i in yesnovar){
  levels(both[,i]) <- c("no", "yes") 
}

```

## Descriptives

Describe the database, both for all IMPACT studies seperately, as well as combined. Note that not all variables are available in all IMPACT studies, and the definition of some varies as well across studies (for example for marshall ct-class).
```{r, message=FALSE, warning=FALSE}
tblvars <- varnames[3:14]
tblfacvars <- factorvars[3:10]
tblnonnorm <- "age"
tbl1 <- CreateTableOne(vars = tblvars, 
                       strata = "trial", 
                       data = both,
                       factorVars = tblfacvars)
tbl1.p <- print(tbl1, nonnorm=tblnonnorm, printToggle=FALSE, missing=TRUE)
kable(tbl1.p)
write.csv2(tbl1.p, file = "Output/tbl1_cv_all.csv")

centerno <- both
centerno$center <- ifelse(centerno$trial=="center",1,0)
tbl1 <- CreateTableOne(vars = tblvars, 
                       strata = "center", 
                       data = centerno,
                       factorVars = tblfacvars)
tbl1.p <- print(tbl1, 
                nonnorm=tblnonnorm, 
                contDigits=1,
                catDigits=0,
                printToggle=FALSE, 
                missing=TRUE)
kable(tbl1.p)
write.csv2(tbl1.p, file = "Output/tbl1_cv_centernot.csv")

unfav.impact <- paste(table(centerno$d_gos[centerno$center==0]%in%c(2,3))["TRUE"],
                      " [", 
                      sprintf("%.0f", 
                              prop.table(
                                table(
                                  centerno$d_gos[centerno$center==0]%in%c(2,3)
                                  )
                                )["TRUE"]*100
                              ),
                      "]",
                      sep="")
unfav.center <- paste(table(centerno$d_gos[centerno$center==1]%in%c(2,3))["TRUE"],
                      " [", 
                      sprintf("%.0f", 
                              prop.table(
                                table(
                                  centerno$d_gos[centerno$center==1]%in%c(2,3)
                                  )
                                )["TRUE"]*100
                              ),
                      "]",
                      sep="")
```

The baseline characteristics differed substantially between the studies. In the IMPACT database, patients were younger (`r tbl1.p[2,1]` versus `r tbl1.p[2,2]` years), had less traumatic subarachnoid hemorrhages (`r tbl1.p[11,1]` versus `r tbl1.p[11,2]`), and presented less often with a motor GCS of one (`r tbl1.p[16,1]` versus `r tbl1.p[16,2]`). However, the patients showed similar Glasgow Outcome Scale in the two studies:  In the IMPACT database, `r tbl1.p[27,1]` died and `r unfav.impact` had an unfavourable outcome, and in the CENTER-TBI study `r tbl1.p[27,2]` died and `r unfav.center` had unfavourable outcome (table 2). For an overview of the patient characteristics per study in IMPACT and CENTER-TBI, see appendix 1. 


## Train and validate

```{r imputation, eval=FALSE, include=FALSE}
##impute
bothi0 <- mice(both, maxit=0)
meth <- bothi0$method
pred <- bothi0$predictorMatrix

meth[which(meth=="pmm")]   <- "midastouch"
meth[c("d_pupil","d_gos")] <- "polr"

pred[,c("trial", "patid")] <- 0
pred["d_gos",]             <- 0


bothi <- mice(both, method = meth, predictorMatrix = pred, m=2, printFlag = FALSE, seed = 1234)
save(bothi, file="Data/bothi_imputed.RData")
```


```{r setup ml, echo=FALSE}
#setup machine learning
load("Data/bothi_imputed.RData")
bothi <- complete(bothi, 1)

bothi$unfav <- factor(ifelse(bothi$d_gos%in%c(2,3),"unfav","fav"))
bothi$mort  <- factor(ifelse(bothi$d_gos==2,"dead","alive"))

##normalize variables
meansodium <- mean(bothi$sodium)
sdsodium   <- sd(bothi$sodium)
bothi$sodium <- (bothi$sodium-meansodium)/sdsodium
meanhb <- mean(bothi$hb)
sdhb   <- sd(bothi$hb)
bothi$hb <- (bothi$hb-meanhb)/sdhb
meanglu <- mean(bothi$glucose)
sdglu   <- sd(bothi$glucose)
bothi$glucose <- (bothi$glucose-meanglu)/sdglu
meanage <- mean(bothi$age)
sdage <- sd(bothi$age)
bothi$age <- (bothi$age-meanage)/sdage

##one-hot encode
multvars <- c("d_motor", "d_pupil", "ct_class")
dmy <- dummyVars(" ~ .",data =  bothi[,multvars])
onehot <- predict(dmy, newdata=bothi[,multvars])
bothi <- bothi[,-which(colnames(bothi)%in%multvars)] 
bothi <- cbind(bothi,onehot)

source("ll.calc.R")
fitControl<- trainControl(## 10-fold CV
  method = "repeatedcv",
  number = 10,
  ## repeated ten times
  repeats = 10,
  classProbs=TRUE,
  ##specify which metric to optimize
  summaryFunction = ll.calc)

models <- c("LR", "svmLinear", "ranger", "nnet", "gbm", "lasso","ridge")
trials <- as.character(unique(bothi$trial))
source("Val.prob.ci.2/auc.nonpara.mw.R")
source("Val.prob.ci.2/ci.auc.R")
source("Val.prob.ci.2/val.prob.ci.2.R")

vars <- c("age", 
          paste("d_motor",1:6, sep="."), 
          paste("d_pupil", 1:3, sep="."), 
          paste("ct_class",1:5, sep="."),
          "tsah", "edh", "hypoxia", "hypotens", "glucose", "hb")
vars_mort <- c(vars,"mort")
vars_unfav <- c(vars,"unfav")
```


train and validate: cv_perstudy.R or cv_10x.R

## internal-external and external

```{r combine trainings}
load("Output/results_cv/results.cs.perstudy_gbm_.RData")
result.cv.perstudy_main <- result.cv.perstudy
load("Output/results_cv/results.cs.perstudy_LR_.RData")
result.cv.perstudy_main <- rbind(result.cv.perstudy_main,result.cv.perstudy)
load("Output/results_cv/results.cs.perstudy_ranger_.RData")
result.cv.perstudy_main <- rbind(result.cv.perstudy_main,result.cv.perstudy)
load("Output/results_cv/results.cs.perstudy_lasso_.RData")
result.cv.perstudy_main <- rbind(result.cv.perstudy_main,result.cv.perstudy)
load("Output/results_cv/results.cs.perstudy_nnet_.RData")
result.cv.perstudy_main <- rbind(result.cv.perstudy_main,result.cv.perstudy)
load("Output/results_cv/results.cs.perstudy_ridge_.RData")
result.cv.perstudy_main <- rbind(result.cv.perstudy_main,result.cv.perstudy)
load("Output/results_cv/results.cs.perstudy_svmLinear_.RData")
result.cv.perstudy <- rbind(result.cv.perstudy_main,result.cv.perstudy)

result.cv.perstudy$nice <- nice_res2(result.cv.perstudy$est, result.cv.perstudy$lo, result.cv.perstudy$hi)

```


```{r forest plots}


key.impact.center <- data.frame(prev.lab=levels(bothi$trial),
                                new.lab=c("TINT", "TIUS", "SLIN", "SAP", "PEG", 
                                          "HITI", "UK4", "TCDB", "SKB", "EBIC", 
                                          "HITII", "NABIS", "CSTAT", "PHAMOS", 
                                          "APOE", "CENTER-TBI"))
result.cv.perstudy <- merge(result.cv.perstudy,key.impact.center, by.x="study", by.y="prev.lab", all.x=TRUE)
result.cv.perstudy$rct_obs <- ifelse(result.cv.perstudy$new.lab%in%c("CENTER-TBI", "TCDB", "EBIC", "UK4", "APOE"),
                                     "Observational", "RCT")

n.df <- data.frame(table(both$trial))
colnames(n.df) <- c("study", "n")
result.cv.perstudy <- merge(result.cv.perstudy, n.df, by="study")
result.cv.perstudy$Model <- result.cv.perstudy$model 
levels(result.cv.perstudy$Model) <- c("GBM","LR","RF","Lasso","NN","Ridge","SVM")
result.cv.perstudy$Model <- factor(result.cv.perstudy$Model, levels=c("LR","SVM","RF","NN","GBM","Lasso","Ridge"))


plot_c.obs <- ggplot(result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                          result.cv.perstudy$measure=="c"&
                                          result.cv.perstudy$outcome=="mort"&
                                          result.cv.perstudy$rct_obs=="Observational",], 
       aes(x=new.lab, y=est, ymin=lo, ymax=hi, col=Model))+
  geom_linerange(position = position_dodge(width = 0.9), cex=2)+ 
  scale_y_continuous(limit=c(0.6,0.95))+
  geom_point(position = position_dodge(width = 0.9), cex=4)+
  xlab("Study")+ylab("Estimated C-statistic")+
  ggtitle("A")+
  facet_wrap(~rct_obs)+
  theme_bw(base_size = 15)+
  theme(legend.position="none",
        axis.title.x = element_text(size=28),
        axis.text.x=element_text(size=24, angle = 90),
        axis.title.y=element_text(size=28),
        axis.text.y=element_text(size=24))
plot_c.rct <- ggplot(result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                          result.cv.perstudy$measure=="c"&
                                          result.cv.perstudy$outcome=="mort"&
                                          result.cv.perstudy$rct_obs=="RCT",], 
                     aes(x=new.lab, y=est, ymin=lo, ymax=hi, col=Model))+
  geom_linerange(position = position_dodge(width = 0.9), cex=2)+ 
  geom_point(position = position_dodge(width = 0.9), cex=4)+
  scale_y_continuous(name="", limit=c(0.6,0.95))+
  xlab("Study")+ylab("Estimated C-statistic")+
  facet_wrap(~rct_obs)+
  theme_bw(base_size = 15)+
  theme(axis.title.x = element_text(size=28),
        axis.text.x=element_text(size=24, angle = 90),
        axis.title.y=element_text(size=28),
        axis.text.y=element_text(size=24),
        legend.title=element_text(size=28),
        legend.text=element_text(size=24))

plot_a.obs <- ggplot(result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                          result.cv.perstudy$measure=="a"&
                                      result.cv.perstudy$outcome=="mort"&
                                      result.cv.perstudy$rct_obs=="Observational",], 
       aes(x=new.lab, y=est, ymin=lo, ymax=hi, col=Model))+
  geom_linerange(position = position_dodge(width = 0.9), cex=2)+ 
  geom_point(position = position_dodge(width = 0.9), cex=4)+
  xlab("Study")+ylab("Estimated calibration intercept")+
  ggtitle("B")+
  scale_y_continuous(limits=c(-1.3, 1.5))+
  geom_hline(yintercept = 0, lty=2)+
  facet_wrap(~rct_obs)+
  theme_bw(base_size = 15)+
  theme(legend.position="none",
        axis.title.x = element_text(size=28),
        axis.text.x=element_text(size=24, angle = 90),
        axis.title.y=element_text(size=28),
        axis.text.y=element_text(size=24))
plot_a.rct <- ggplot(result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                          result.cv.perstudy$measure=="a"&
                                          result.cv.perstudy$outcome=="mort"&
                                          result.cv.perstudy$rct_obs=="RCT",], 
                     aes(x=new.lab, y=est, ymin=lo, ymax=hi, col=Model))+
  geom_linerange(position = position_dodge(width = 0.9), cex=2)+ 
  geom_point(position = position_dodge(width = 0.9), cex=4)+
  scale_y_continuous(name = "", limits=c(-1.3, 1.5))+
  xlab("Study")+ylab("Estimated calibration intercept")+
  geom_hline(yintercept = 0, lty=2)+
  facet_wrap(~rct_obs)+
  theme_bw(base_size = 15)+
  theme(axis.title.x = element_text(size=28),
        axis.text.x=element_text(size=24, angle = 90),
        axis.title.y=element_text(size=28),
        axis.text.y=element_text(size=24),
        legend.title=element_text(size=28),
        legend.text=element_text(size=24))

plot_b.obs <- ggplot(result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                          result.cv.perstudy$measure=="b"&
                                      result.cv.perstudy$outcome=="mort"&
                                      result.cv.perstudy$rct_obs=="Observational",], 
       aes(x=new.lab, y=est, ymin=lo, ymax=hi, col=Model))+
  geom_linerange(position = position_dodge(width = 0.9), cex=2)+ 
  geom_point(position = position_dodge(width = 0.9), cex=4)+
  xlab("Study")+ylab("Estimated calibration slope")+
  scale_y_continuous(limits=c(0.1,2))+
  ggtitle(label = "C")+
  geom_hline(yintercept = 1, lty=2)+
  facet_wrap(~rct_obs)+
  theme_bw(base_size = 15)+
  theme(legend.position="none",
        axis.title.x = element_text(size=28),
        axis.text.x=element_text(size=24, angle = 90),
        axis.title.y=element_text(size=28),
        axis.text.y=element_text(size=24))
plot_b.rct <- ggplot(result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                          result.cv.perstudy$measure=="b"&
                                          result.cv.perstudy$outcome=="mort"&
                                          result.cv.perstudy$rct_obs=="RCT",], 
                     aes(x=new.lab, y=est, ymin=lo, ymax=hi, col=Model))+
  geom_linerange(position = position_dodge(width = 0.9), cex=2)+ 
  geom_point(position = position_dodge(width = 0.9), cex=4)+
  xlab("Study")+ylab("Estimated calibration slope")+
  scale_y_continuous(name = "", limits=c(0.1,2))+
  geom_hline(yintercept = 1, lty=2)+
  facet_wrap(~rct_obs)+
  theme_bw(base_size = 15)+
  theme(axis.title.x = element_text(size=28),
        axis.text.x=element_text(size=24, angle = 90),
        axis.title.y=element_text(size=28),
        axis.text.y=element_text(size=24),
        legend.title=element_text(size=28),
        legend.text=element_text(size=24))


plot_brier.obs <- ggplot(result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                          result.cv.perstudy$measure=="brier"&
                                      result.cv.perstudy$outcome=="mort"&
                                      result.cv.perstudy$rct_obs=="Observational",], 
       aes(x=new.lab, y=est, ymin=lo, ymax=hi, col=Model))+
  geom_linerange(position = position_dodge(width = 0.9), cex=2)+ 
  geom_point(position = position_dodge(width = 0.9), cex=4)+
  xlab("Study")+ylab("Estimated brier score")+
  scale_y_continuous(limits=c(0,0.3))+
  ggtitle(label = "D")+
  facet_wrap(~rct_obs)+
  theme_bw(base_size = 15)+
  theme(legend.position="none",
        axis.title.x = element_text(size=28),
        axis.text.x=element_text(size=24, angle = 90),
        axis.title.y=element_text(size=28),
        axis.text.y=element_text(size=24))
plot_brier.rct <- ggplot(result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                          result.cv.perstudy$measure=="brier"&
                                          result.cv.perstudy$outcome=="mort"&
                                          result.cv.perstudy$rct_obs=="RCT",], 
                     aes(x=new.lab, y=est, ymin=lo, ymax=hi, col=Model))+
  geom_linerange(position = position_dodge(width = 0.9), cex=2)+ 
  geom_point(position = position_dodge(width = 0.9), cex=4)+
  xlab("Study")+ylab("Estimated calibration slope")+
  scale_y_continuous(name = "", limits=c(0,0.3))+
  facet_wrap(~rct_obs)+
  theme_bw(base_size = 15)+
  theme(axis.title.x = element_text(size=28),
        axis.text.x=element_text(size=24, angle = 90),
        axis.title.y=element_text(size=28),
        axis.text.y=element_text(size=24),
        legend.title=element_text(size=28),
        legend.text=element_text(size=24))
bgravesteijn::multiplot(plot_a.obs,plot_a.rct,
                        plot_b.obs,plot_b.rct,
                        plot_c.obs,plot_c.rct,
                        plot_brier.obs, plot_brier.rct,
                        layout=matrix(1:8, ncol = 2, byrow = TRUE))

tiff("Output/cv_all_studies_ranger.tiff", width=20000, height=11000,res=800, compression="lzw")
bgravesteijn::multiplot(plot_c.obs+plot_c.rct,
                        plot_a.obs+plot_a.rct,
                        plot_b.obs+plot_b.rct,
                        plot_brier.obs+ plot_brier.rct,
                        layout=matrix(1:4, ncol = 2, byrow = TRUE))
dev.off()
pdf("Output/cv_all_studies.pdf", width=25, height=10)
plot_a.obs+plot_a.rct
plot_b.obs+plot_b.rct
plot_c.obs+plot_c.rct
dev.off()
```

```{r}
cstattbl<-data.table(result.cv.perstudy[result.cv.perstudy$measure=="c",])
cstattbl1<-cstattbl[outcome=="mort"&new.lab!="CENTER-TBI",.(median(est), 
                                      quantile(est,probs=0.25), 
                                      quantile(est,probs=0.75)), by=model]
cstattbl1$all<-nice_res2(x = cstattbl1$V1, xlo = cstattbl1$V2, xhi= cstattbl1$V3)
cstattbl1<-cstattbl1[,c(1,5)]
cstattbl2<-cstattbl[new.lab=="CENTER-TBI"&outcome=="mort",.(nice), by=model]
mort_c<-merge(cstattbl1,cstattbl2, by="model")
cstattbl1<-cstattbl[outcome=="unfav"&new.lab!="CENTER-TBI",.(median(est), 
                                       quantile(est,probs=0.25), 
                                       quantile(est,probs=0.75)), by=model]
cstattbl1$all<-nice_res2(x = cstattbl1$V1, xlo = cstattbl1$V2, xhi= cstattbl1$V3)
cstattbl1<-cstattbl1[,c(1,5)]
cstattbl2<-cstattbl[new.lab=="CENTER-TBI"&outcome=="unfav",.(nice), by=model]
unfav_c<-merge(cstattbl1,cstattbl2, by="model")
c_res<-rbind(mort_c, unfav_c)
c_res$outcome<-c(rep("mort", 0.5*nrow(c_res)), rep("unfav", 0.5*nrow(c_res)))

c_res$me_avg <- 0

re_pool <- function(se=NULL, est=NULL,logtransf=FALSE){
  ##https://www.meta-analysis.com/downloads/M-a_f_e_v_r_e_sv.pdf##
  
  w  <- (1/(se^2))
  mu <- mean(est)
  q <- sum(w*((est-mu)^2))
  c <- sum(w)-((sum(w^2))/sum(w))
  tau2 <- (q-(length(est)-1))/c
  
  w_re <- (1/((se^2)+tau2))
  est_pool <- weighted.mean(x = est, w = w_re)
  se_pool <- sqrt((1/sum(w_re)))
  if(logtransf){
    res <-   nice_res2(x = exp(est_pool), 
                       xlo = exp(est_pool-1.96*se_pool), 
                       xhi = exp(est_pool+1.96*se_pool))
  }else{
   res <-   nice_res2(x = est_pool, xlo = est_pool-1.96*se_pool, xhi = est_pool+1.96*se_pool) 
  }
  return(res)
}

for(i in unique(c_res$model)){
  data_mort <- result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                    result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="mort"&
                      result.cv.perstudy$measure=="c",]
  data_mort$se <- (data_mort$hi-data_mort$est)/1.96
  c_res$me_avg[c_res$model==i&
                 c_res$outcome=="mort"] <- re_pool(se = data_mort$se, est=data_mort$est)
  
  data_unfav <- result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                     result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="unfav"&
                      result.cv.perstudy$measure=="c",]
  data_unfav$se <- (data_unfav$hi-data_unfav$est)/1.96
  c_res$me_avg[c_res$model==i&
                 c_res$outcome=="unfav"] <- re_pool(se = data_unfav$se, est=data_unfav$est)
  
}

astattbl<-data.table(result.cv.perstudy[result.cv.perstudy$measure=="a",])
astattbl1<-astattbl[outcome=="mort"&new.lab!="CENTER-TBI",.(median(est), 
                                      quantile(est,probs=0.25), 
                                      quantile(est,probs=0.75)), by=model]
astattbl1$all<-nice_res2(x = astattbl1$V1, xlo = astattbl1$V2, xhi= astattbl1$V3)
astattbl1<-astattbl1[,c(1,5)]
astattbl2<-astattbl[new.lab=="CENTER-TBI"&outcome=="mort",.(nice), by=model]
mort_a<-merge(astattbl1,astattbl2, by="model")
astattbl1<-astattbl[outcome=="unfav"&new.lab!="CENTER-TBI",.(median(est), 
                                       quantile(est,probs=0.25), 
                                       quantile(est,probs=0.75)), by=model]
astattbl1$all<-nice_res2(x = astattbl1$V1, xlo = astattbl1$V2, xhi= astattbl1$V3)
astattbl1<-astattbl1[,c(1,5)]
astattbl2<-astattbl[new.lab=="CENTER-TBI"&outcome=="unfav",.(nice), by=model]
unfav_a<-merge(astattbl1,astattbl2, by="model")
a_res<-rbind(mort_a, unfav_a)
a_res$outcome<-c(rep("mort", 0.5*nrow(c_res)), rep("unfav", 0.5*nrow(c_res)))

a_res$me_avg <- 0
for(i in unique(a_res$model)){
  data_mort <- result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                    result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="mort"&
                      result.cv.perstudy$measure=="a",]
  data_mort$se <- (data_mort$hi-data_mort$est)/1.96
  a_res$me_avg[a_res$model==i&
                 a_res$outcome=="mort"] <- re_pool(se = data_mort$se, est=data_mort$est)
  
  data_unfav <- result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                     result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="unfav"&
                      result.cv.perstudy$measure=="a",]
  data_unfav$se <- (data_unfav$hi-data_unfav$est)/1.96
  a_res$me_avg[a_res$model==i&
                 a_res$outcome=="unfav"] <- re_pool(se = data_unfav$se, est=data_unfav$est)
  
}


bstattbl<-data.table(result.cv.perstudy[result.cv.perstudy$measure=="b",])
bstattbl1<-bstattbl[outcome=="mort"&new.lab!="CENTER-TBI",.(median(est), 
                                      quantile(est,probs=0.25), 
                                      quantile(est,probs=0.75)), by=model]
bstattbl1$all<-nice_res2(x = bstattbl1$V1, xlo = bstattbl1$V2, xhi= bstattbl1$V3)
bstattbl1<-bstattbl1[,c(1,5)]
bstattbl2<-bstattbl[new.lab=="CENTER-TBI"&outcome=="mort",.(nice), by=model]
mort_b<-merge(bstattbl1,bstattbl2, by="model")
bstattbl1<-bstattbl[outcome=="unfav"&new.lab!="CENTER-TBI",.(median(est), 
                                       quantile(est,probs=0.25), 
                                       quantile(est,probs=0.75)), by=model]
bstattbl1$all<-nice_res2(x = bstattbl1$V1, xlo = bstattbl1$V2, xhi= bstattbl1$V3)
bstattbl1<-bstattbl1[,c(1,5)]
bstattbl2<-bstattbl[new.lab=="CENTER-TBI"&outcome=="unfav",.(nice), by=model]
unfav_b<-merge(bstattbl1,bstattbl2, by="model")
b_res<-rbind(mort_b, unfav_b)
b_res$outcome<-c(rep("mort", 0.5*nrow(c_res)), rep("unfav", 0.5*nrow(c_res)))

b_res$me_avg <- 0
for(i in unique(b_res$model)){
  data_mort <- result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                    result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="mort"&
                      result.cv.perstudy$measure=="b",]
  data_mort$se <- (data_mort$hi-data_mort$est)/1.96
  b_res$me_avg[b_res$model==i&
                 b_res$outcome=="mort"] <- re_pool(se = data_mort$se, est=data_mort$est)
  
  data_unfav <- result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                     result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="unfav"&
                      result.cv.perstudy$measure=="b",]
  data_unfav$se <- (data_unfav$hi-data_unfav$est)/1.96
  b_res$me_avg[b_res$model==i&
                 b_res$outcome=="unfav"] <- re_pool(se = data_unfav$se, est=data_unfav$est)
  
}

brierstattbl<-data.table(result.cv.perstudy[result.cv.perstudy$measure=="brier",])
brierstattbl1<-brierstattbl[outcome=="mort"&new.lab!="CENTER-TBI",.(median(est), 
                                      quantile(est,probs=0.25), 
                                      quantile(est,probs=0.75)), by=model]
brierstattbl1$all<-nice_res2(x = brierstattbl1$V1, xlo = brierstattbl1$V2, xhi= brierstattbl1$V3)
brierstattbl1<-brierstattbl1[,c(1,5)]
brierstattbl2<-brierstattbl[new.lab=="CENTER-TBI"&outcome=="mort",.(nice), by=model]
mort_brier<-merge(brierstattbl1,brierstattbl2, by="model")
brierstattbl1<-brierstattbl[outcome=="unfav"&new.lab!="CENTER-TBI",.(median(est), 
                                       quantile(est,probs=0.25), 
                                       quantile(est,probs=0.75)), by=model]
brierstattbl1$all<-nice_res2(x = brierstattbl1$V1, xlo = brierstattbl1$V2, xhi= brierstattbl1$V3)
brierstattbl1<-brierstattbl1[,c(1,5)]
brierstattbl2<-brierstattbl[new.lab=="CENTER-TBI"&outcome=="unfav",.(nice), by=model]
unfav_brier<-merge(brierstattbl1,brierstattbl2, by="model")
brier_res<-rbind(mort_brier, unfav_brier)
brier_res$outcome<-c(rep("mort", 0.5*nrow(c_res)), rep("unfav", 0.5*nrow(c_res)))

brier_res$me_avg <- 0
for(i in unique(brier_res$model)){
  data_mort <- result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                    result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="mort"&
                      result.cv.perstudy$measure=="brier",]
  data_mort$se <- (data_mort$hi-data_mort$est)/1.96
  brier_res$me_avg[brier_res$model==i&
                 brier_res$outcome=="mort"] <- re_pool(se = data_mort$se, est=data_mort$est)
  
  data_unfav <- result.cv.perstudy[result.cv.perstudy$new.lab!="CENTER-TBI"&
                                     result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="unfav"&
                      result.cv.perstudy$measure=="brier",]
  data_unfav$se <- (data_unfav$hi-data_unfav$est)/1.96
  brier_res$me_avg[brier_res$model==i&
                 brier_res$outcome=="unfav"] <- re_pool(se = data_unfav$se, est=data_unfav$est)
  
}

b_res<-b_res[c(2,7,3,5,1,4,6,
                 9,14,10,12,8,11,13),
             c(1,4,5,3)]
a_res<-a_res[c(2,7,3,5,1,4,6,
                 9,14,10,12,8,11,13),
             c(1,4,5,3)]
c_res<-c_res[c(2,7,3,5,1,4,6,
                 9,14,10,12,8,11,13),
             c(1,4,5,3)]
brier_res<-brier_res[c(2,7,3,5,1,4,6,
                 9,14,10,12,8,11,13),
                 c(1,4,5,3)]

kable(c_res)
kable(a_res)
kable(b_res)
kable(brier_res)
write.csv2(b_res, file = "Output/result_b.csv")
write.csv2(brier_res, file = "Output/result_brier.csv")
write.csv2(a_res, file = "Output/result_a.csv")
write.csv2(c_res, file = "Output/result_c.csv")
```



```{r heterogeneity}
fit_c <- lmer(est~1+(1|model)+(1|study), result.cv.perstudy[result.cv.perstudy$measure=="c"&
                                                            result.cv.perstudy$outcome=="mort",])
fit_a <- lmer(est~1+(1|model)+(1|study), result.cv.perstudy[result.cv.perstudy$measure=="a"&
                                                            result.cv.perstudy$outcome=="mort",])
fit_b <- lmer(est~1+(1|model)+(1|study), result.cv.perstudy[result.cv.perstudy$measure=="b"&
                                                            result.cv.perstudy$outcome=="mort",])
fit_brier <- lmer(est~1+(1|model)+(1|study), result.cv.perstudy[result.cv.perstudy$measure=="brier"&
                                                            result.cv.perstudy$outcome=="mort",])

vc_c <- lme4::VarCorr(fit_c)
vc_a <- lme4::VarCorr(fit_a)
vc_b <- lme4::VarCorr(fit_b)
vc_brier <- lme4::VarCorr(fit_brier)
prop.var.c1_s <- data.frame(vc_c)$vcov[1]/sum(data.frame(vc_c)$vcov)
prop.var.a1_s <- data.frame(vc_a)$vcov[1]/sum(data.frame(vc_a)$vcov)
prop.var.b1_s <- data.frame(vc_b)$vcov[1]/sum(data.frame(vc_b)$vcov)
prop.var.brier1_s <- data.frame(vc_brier)$vcov[1]/sum(data.frame(vc_brier)$vcov)
prop.var.c1_m <- data.frame(vc_c)$vcov[2]/sum(data.frame(vc_c)$vcov)
prop.var.a1_m <- data.frame(vc_a)$vcov[2]/sum(data.frame(vc_a)$vcov)
prop.var.b1_m <- data.frame(vc_b)$vcov[2]/sum(data.frame(vc_b)$vcov)
prop.var.brier1_m <- data.frame(vc_brier)$vcov[2]/sum(data.frame(vc_brier)$vcov)

fit_c <- lmer(est~1+(1|model)+(1|study), result.cv.perstudy[result.cv.perstudy$measure=="c"&
                                                            result.cv.perstudy$outcome=="unfav",])
fit_a <- lmer(est~1+(1|model)+(1|study), result.cv.perstudy[result.cv.perstudy$measure=="a"&
                                                            result.cv.perstudy$outcome=="unfav",])
fit_b <- lmer(est~1+(1|model)+(1|study), result.cv.perstudy[result.cv.perstudy$measure=="b"&
                                                            result.cv.perstudy$outcome=="unfav",])
fit_brier <- lmer(est~1+(1|model)+(1|study), result.cv.perstudy[result.cv.perstudy$measure=="brier"&
                                                            result.cv.perstudy$outcome=="unfav",])

vc_c <- lme4::VarCorr(fit_c)
vc_a <- lme4::VarCorr(fit_a)
vc_b <- lme4::VarCorr(fit_b)
vc_brier <- lme4::VarCorr(fit_brier)
prop.var.c2_s <- data.frame(vc_c)$vcov[1]/sum(data.frame(vc_c)$vcov)
prop.var.a2_s <- data.frame(vc_a)$vcov[1]/sum(data.frame(vc_a)$vcov)
prop.var.b2_s <- data.frame(vc_b)$vcov[1]/sum(data.frame(vc_b)$vcov)
prop.var.brier2_s <- data.frame(vc_brier)$vcov[1]/sum(data.frame(vc_brier)$vcov)
prop.var.c2_m <- data.frame(vc_c)$vcov[2]/sum(data.frame(vc_c)$vcov)
prop.var.a2_m <- data.frame(vc_a)$vcov[2]/sum(data.frame(vc_a)$vcov)
prop.var.b2_m <- data.frame(vc_b)$vcov[2]/sum(data.frame(vc_b)$vcov)
prop.var.brier2_m <- data.frame(vc_brier)$vcov[2]/sum(data.frame(vc_brier)$vcov)

res.htrg <- data.frame(mortality=rep(" ", 4),
                       model = sprintf("%.1f",
                                       c(prop.var.c1_m, 
                                         prop.var.a1_m, 
                                         prop.var.b1_m,
                                         prop.var.brier1_m)*100),
                       study = sprintf("%.1f",
                                       c(prop.var.c1_s, 
                                         prop.var.a1_s, 
                                         prop.var.b1_s,
                                         prop.var.brier1_s)*100),
                       unfavorable=rep(" ", 4),
                       model = sprintf("%.1f",
                                       c(prop.var.c2_m, 
                                         prop.var.a2_m, 
                                         prop.var.b2_m, 
                                         prop.var.brier2_m)*100), 
                       study = sprintf("%.1f",
                                       c(prop.var.c2_s, 
                                         prop.var.a2_s,  
                                         prop.var.b2_s, 
                                         prop.var.brier2_s)*100))
rownames(res.htrg) <- c("C-statistic", "Calibration intercept", "Calibration slope", "Brier score")
res.htrg <- t(res.htrg)
kable(res.htrg)
write.csv2(res.htrg, file="Output/heterogeneity.csv")
```

 

## internal 10x10 cross validation 


```{r combine trainings}
load("Output/results_cv/results.cs.intern_gbm_.RData")
result.cv.intern_main <- result.cv.intern
load("Output/results_cv/results.cs.intern_LR_.RData")
result.cv.intern_main <- rbind(result.cv.intern_main,result.cv.intern)
load("Output/results_cv/results.cs.intern_rf_.RData")
result.cv.intern_main <- rbind(result.cv.intern_main,result.cv.intern)
load("Output/results_cv/results.cs.intern_lasso_.RData")
result.cv.intern_main <- rbind(result.cv.intern_main,result.cv.intern)
load("Output/results_cv/results.cs.intern_nnet_.RData")
result.cv.intern_main <- rbind(result.cv.intern_main,result.cv.intern)
load("Output/results_cv/results.cs.intern_ridge_.RData")
result.cv.intern_main <- rbind(result.cv.intern_main,result.cv.intern)
load("Output/results_cv/results.cs.intern_svmLinear_.RData")
result.cv.intern <- rbind(result.cv.intern_main,result.cv.intern)

result.cv.intern$nice <- nice_res2(result.cv.intern$est, result.cv.intern$lo, result.cv.intern$hi)


brierstattbl<-data.table(result.cv.intern[result.cv.intern$measure=="brier",])
brierstattbl1<-brierstattbl[outcome=="mort",.(median(est), 
                                      quantile(est,probs=0.25), 
                                      quantile(est,probs=0.75)), by=model]
brierstattbl1$all<-nice_res2(x = brierstattbl1$V1, xlo = brierstattbl1$V2, xhi= brierstattbl1$V3)
brierstattbl1<-brierstattbl1[,c(1,5)]

brierstattbl2<-brierstattbl[outcome=="unfav",.(median(est), 
                                       quantile(est,probs=0.25), 
                                       quantile(est,probs=0.75)), by=model]
brierstattbl2$all<-nice_res2(x = brierstattbl2$V1, xlo = brierstattbl2$V2, xhi= brierstattbl2$V3)
brierstattbl2<-brierstattbl2[,c(1,5)]

brier_res <- rbind(brierstattbl1, brierstattbl2)
  
brier_res$outcome<-c(rep("mort", 0.5*nrow(brier_res)), rep("unfav", 0.5*nrow(brier_res)))

brier_res$me_avg <- 0
for(i in unique(brier_res$model)){
  data_mort <- result.cv.intern[result.cv.intern$model==i&
                      result.cv.intern$outcome=="mort"&
                      result.cv.intern$measure=="brier",]
  data_mort$se <- (data_mort$hi-data_mort$est)/1.96
  brier_res$me_avg[brier_res$model==i&
                 brier_res$outcome=="mort"] <- re_pool(se = data_mort$se, est=data_mort$est)
  
  data_unfav <- result.cv.intern[result.cv.intern$model==i&
                      result.cv.intern$outcome=="unfav"&
                      result.cv.intern$measure=="brier",]
  data_unfav$se <- (data_unfav$hi-data_unfav$est)/1.96
  brier_res$me_avg[brier_res$model==i&
                 brier_res$outcome=="unfav"] <- re_pool(se = data_unfav$se, est=data_unfav$est)
  
}
brier_res<-brier_res[c(2,7,3,5,1,4,6,
                 9,14,10,12,8,11,13),
                 c(1,3,4)]

cstattbl<-data.table(result.cv.intern[result.cv.intern$measure=="c",])
cstattbl1<-cstattbl[outcome=="mort",.(median(est), 
                                      quantile(est,probs=0.25), 
                                      quantile(est,probs=0.75)), by=model]
cstattbl1$all<-nice_res2(x = cstattbl1$V1, xlo = cstattbl1$V2, xhi= cstattbl1$V3)
cstattbl1<-cstattbl1[,c(1,5)]

cstattbl2<-cstattbl[outcome=="unfav",.(median(est), 
                                       quantile(est,probs=0.25), 
                                       quantile(est,probs=0.75)), by=model]
cstattbl2$all<-nice_res2(x = cstattbl2$V1, xlo = cstattbl2$V2, xhi= cstattbl2$V3)
cstattbl2<-cstattbl2[,c(1,5)]

c_res <- rbind(cstattbl1, cstattbl2)
  
c_res$outcome<-c(rep("mort", 0.5*nrow(c_res)), rep("unfav", 0.5*nrow(c_res)))

c_res$me_avg <- 0
for(i in unique(c_res$model)){
  data_mort <- result.cv.intern[result.cv.intern$model==i&
                      result.cv.intern$outcome=="mort"&
                      result.cv.intern$measure=="c",]
  data_mort$se <- (data_mort$hi-data_mort$est)/1.96
  c_res$me_avg[c_res$model==i&
                 c_res$outcome=="mort"] <- re_pool(se = data_mort$se, est=data_mort$est)
  
  data_unfav <- result.cv.intern[result.cv.intern$model==i&
                      result.cv.intern$outcome=="unfav"&
                      result.cv.intern$measure=="c",]
  data_unfav$se <- (data_unfav$hi-data_unfav$est)/1.96
  c_res$me_avg[c_res$model==i&
                 c_res$outcome=="unfav"] <- re_pool(se = data_unfav$se, est=data_unfav$est)
  
}
c_res<-c_res[c(2,7,3,5,1,4,6,
                 9,14,10,12,8,11,13),
                 c(1,3,4)]

astattbl<-data.table(result.cv.intern[result.cv.intern$measure=="a",])
astattbl1<-astattbl[outcome=="mort",.(median(est), 
                                      quantile(est,probs=0.25), 
                                      quantile(est,probs=0.75)), by=model]
astattbl1$all<-nice_res2(x = astattbl1$V1, xlo = astattbl1$V2, xhi= astattbl1$V3)
astattbl1<-astattbl1[,c(1,5)]

astattbl2<-astattbl[outcome=="unfav",.(median(est), 
                                       quantile(est,probs=0.25), 
                                       quantile(est,probs=0.75)), by=model]
astattbl2$all<-nice_res2(x = astattbl2$V1, xlo = astattbl2$V2, xhi= astattbl2$V3)
astattbl2<-astattbl2[,c(1,5)]

a_res <- rbind(astattbl1, astattbl2)
  
a_res$outcome<-c(rep("mort", 0.5*nrow(a_res)), rep("unfav", 0.5*nrow(a_res)))

a_res$me_avg <- 0
for(i in unique(a_res$model)){
  data_mort <- result.cv.intern[result.cv.intern$model==i&
                      result.cv.intern$outcome=="mort"&
                      result.cv.intern$measure=="a",]
  data_mort$se <- (data_mort$hi-data_mort$est)/1.96
  a_res$me_avg[a_res$model==i&
                 a_res$outcome=="mort"] <- re_pool(se = data_mort$se, est=data_mort$est)
  
  data_unfav <- result.cv.intern[result.cv.intern$model==i&
                      result.cv.intern$outcome=="unfav"&
                      result.cv.intern$measure=="a",]
  data_unfav$se <- (data_unfav$hi-data_unfav$est)/1.96
  a_res$me_avg[a_res$model==i&
                 a_res$outcome=="unfav"] <- re_pool(se = data_unfav$se, est=data_unfav$est)
  
}
a_res<-a_res[c(2,7,3,5,1,4,6,
                 9,14,10,12,8,11,13),
                 c(1,3,4)]

bstattbl<-data.table(result.cv.intern[result.cv.intern$measure=="b",])
bstattbl1<-bstattbl[outcome=="mort",.(median(est), 
                                      quantile(est,probs=0.25), 
                                      quantile(est,probs=0.75)), by=model]
bstattbl1$all<-nice_res2(x = bstattbl1$V1, xlo = bstattbl1$V2, xhi= bstattbl1$V3)
bstattbl1<-bstattbl1[,c(1,5)]

bstattbl2<-bstattbl[outcome=="unfav",.(median(est), 
                                       quantile(est,probs=0.25), 
                                       quantile(est,probs=0.75)), by=model]
bstattbl2$all<-nice_res2(x = bstattbl2$V1, xlo = bstattbl2$V2, xhi= bstattbl2$V3)
bstattbl2<-bstattbl2[,c(1,5)]

b_res <- rbind(bstattbl1, bstattbl2)
  
b_res$outcome<-c(rep("mort", 0.5*nrow(b_res)), rep("unfav", 0.5*nrow(b_res)))

b_res$me_avg <- 0
for(i in unique(b_res$model)){
  data_mort <- result.cv.intern[result.cv.intern$model==i&
                      result.cv.intern$outcome=="mort"&
                      result.cv.intern$measure=="b",]
  data_mort$se <- (data_mort$hi-data_mort$est)/1.96
  b_res$me_avg[b_res$model==i&
                 b_res$outcome=="mort"] <- re_pool(se = data_mort$se, est=data_mort$est)
  
  data_unfav <- result.cv.intern[result.cv.intern$model==i&
                      result.cv.intern$outcome=="unfav"&
                      result.cv.intern$measure=="b",]
  data_unfav$se <- (data_unfav$hi-data_unfav$est)/1.96
  b_res$me_avg[b_res$model==i&
                 b_res$outcome=="unfav"] <- re_pool(se = data_unfav$se, est=data_unfav$est)
  
}
b_res<-b_res[c(2,7,3,5,1,4,6,
                 9,14,10,12,8,11,13),
                 c(1,3,4)]

write.csv2(brier_res, file = "Output/brier_res_10xcv.csv")
write.csv2(a_res, file = "Output/a_res_10xcv.csv")
write.csv2(b_res, file = "Output/b_res_10xcv.csv")
write.csv2(c_res, file = "Output/c_res_10xcv.csv")
```




```{r sensitivity analysis mi}
load("Output/results.cs.perstudy_sens.RData")

key.impact.center <- data.frame(prev.lab=levels(bothi$trial),
                                new.lab=c("TINT", "TIUS", "SLIN", "SAP", "PEG", 
                                          "HITI", "UK4", "TCDB", "SKB", "EBIC", 
                                          "HITII", "NABIS", "CSTAT", "PHAMOS", 
                                          "APOE", "CENTER-TBI"))
result.cv.perstudy <- merge(result.cv.perstudy,key.impact.center, by.x="study", by.y="prev.lab", all.x=TRUE)
result.cv.perstudy$rct_obs <- ifelse(result.cv.perstudy$new.lab%in%c("CENTER-TBI", "TCDB", "EBIC", "UK4", "APOE"),
                                     "Observational", "RCT")

n.df <- data.frame(table(both$trial))
colnames(n.df) <- c("study", "n")
result.cv.perstudy <- merge(result.cv.perstudy, n.df, by="study")

cstattbl<-data.table(result.cv.perstudy[result.cv.perstudy$measure=="c",])
cstattbl1<-cstattbl[outcome=="mort",.(median(est), 
                                      quantile(est,probs=0.25), 
                                      quantile(est,probs=0.75)), by=model]
cstattbl1$all<-nice_res2(x = cstattbl1$V1, xlo = cstattbl1$V2, xhi= cstattbl1$V3)
cstattbl1<-cstattbl1[,c(1,5)]
cstattbl2<-cstattbl[new.lab=="CENTER-TBI"&outcome=="mort",.(nice), by=model]
mort_c<-merge(cstattbl1,cstattbl2, by="model")
cstattbl1<-cstattbl[outcome=="unfav",.(median(est), 
                                       quantile(est,probs=0.25), 
                                       quantile(est,probs=0.75)), by=model]
cstattbl1$all<-nice_res2(x = cstattbl1$V1, xlo = cstattbl1$V2, xhi= cstattbl1$V3)
cstattbl1<-cstattbl1[,c(1,5)]
cstattbl2<-cstattbl[new.lab=="CENTER-TBI"&outcome=="unfav",.(nice), by=model]
unfav_c<-merge(cstattbl1,cstattbl2, by="model")
c_res<-rbind(mort_c, unfav_c)
c_res$outcome<-c(rep("mort", 0.5*nrow(c_res)), rep("unfav", 0.5*nrow(c_res)))

c_res$me_avg <- 0

for(i in unique(c_res$model)){
  data_mort <- result.cv.perstudy[result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="mort"&
                      result.cv.perstudy$measure=="c",]
  data_mort$se <- (data_mort$hi-data_mort$est)/1.96
  c_res$me_avg[c_res$model==i&
                 c_res$outcome=="mort"] <- re_pool(se = data_mort$se, est=data_mort$est)
  
  data_unfav <- result.cv.perstudy[result.cv.perstudy$model==i&
                      result.cv.perstudy$outcome=="unfav"&
                      result.cv.perstudy$measure=="c",]
  data_unfav$se <- (data_unfav$hi-data_unfav$est)/1.96
  c_res$me_avg[c_res$model==i&
                 c_res$outcome=="unfav"] <- re_pool(se = data_unfav$se, est=data_unfav$est)
  
}

write.csv2(c_res,"Output/c_stat_sensitivity.csv")

```

#explore linearity/additivity assumption

```{r}
fit.mort <- glm(mort~age+
                  d_motor.1+d_motor.2+d_motor.3+d_motor.4+d_motor.5+d_motor.6+
                  d_pupil.1+d_pupil.2+d_pupil.3+
                  ct_class.1+ct_class.2+ct_class.3+ct_class.4+ct_class.5+
                  tsah+
                  edh+
                  hypoxia+
                  hypotens+
                  glucose+
                  hb, data=bothi, family = "binomial")
fit.mort_nl <- glm(mort~rcs(age,3)+
                  d_motor.1+d_motor.2+d_motor.3+d_motor.4+d_motor.5+d_motor.6+
                  d_pupil.1+d_pupil.2+d_pupil.3+
                  ct_class.1+ct_class.2+ct_class.3+ct_class.4+ct_class.5+
                  tsah+
                  edh+
                  hypoxia+
                  hypotens+
                  rcs(glucose,3)+
                  rcs(hb,3), data=bothi, family = "binomial")
fit.mort_na <- glm(mort~(age+
                  tsah+
                  edh+
                  hypoxia+
                  hypotens+
                  glucose+
                  hb)^2+
                  (age+
                  tsah+
                  edh+
                  hypoxia+
                  hypotens+
                  glucose+
                  hb)*(d_motor.1+d_motor.2+d_motor.3+d_motor.4+d_motor.5+d_motor.6+
                  d_pupil.1+d_pupil.2+d_pupil.3+
                  ct_class.1+ct_class.2+ct_class.3+ct_class.4+ct_class.5), data=bothi, 
                  family = "binomial")

assump.test <- expand.grid(trial=levels(bothi$trial),
                           test=c("non-additivity", "non-linearity"),
                           pval=NA)
for(i in levels(bothi$trial)){
  assump.test[assump.test$trial==i&
                assump.test$test=="non-linearity",
              "pval"] <- anova(update(fit.mort, subset=bothi$trial==i), 
                               update(fit.mort_nl, subset=bothi$trial==i), 
                               test="LRT")$`Pr(>Chi)`[2]
  assump.test[assump.test$trial==i&
                assump.test$test=="non-additivity",
              "pval"] <- anova(update(fit.mort, subset=bothi$trial==i), 
                               update(fit.mort_na, subset=bothi$trial==i), 
                               test="LRT")$`Pr(>Chi)`[2]
}

write.csv2(assump.test, file="output/linearity_interaction.csv")
```

